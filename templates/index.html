<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Impressora Bambu</title>
    <!-- Inclui Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- O CSS est√° embutido na tag <style> abaixo -->
    <style>
        :root {
            /* Tema Claro (Padr√£o) */
            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: #fff;
            --item-bg: #f9f9f9;
            --item-alt-bg: #f0f0f0;
            --border-color: #ddd;
            --border-light-color: #eee;
            --link-color: #007bff;
            --header-color: #333;
            --label-color: #666;
            --value-color: #000;
            --success-color: #4CAF50;
            --error-bg: #fdd;
            --error-border: #e74c3c;
            --error-text: #e74c3c;
            --button-bg: #e0e0e0;
            --button-text: #333;
            --shadow-color: rgba(0,0,0,0.1);
        }

        body.dark-theme {
            /* Tema Escuro */
            --bg-color: #000000; /* Alterado para preto */
            --text-color: #dee2e6;
            --container-bg: #181818; /* Alterado para cinza muito escuro */
            --item-bg: #282828; /* Alterado para cinza escuro */
            --item-alt-bg: #383838; /* Ajustado para contraste */
            --border-color: #444; /* Ajustado para contraste */
            --border-light-color: #333; /* Ajustado para contraste */
            --link-color: #77b3ff; /* Ajustado para contraste */
            --header-color: #e9ecef;
            --label-color: #adb5bd;
            --value-color: #f8f9fa;
            --success-color: #28a745;
            --error-bg: #402024; /* Ajustado para contraste */
            --error-border: #a02c38; /* Ajustado para contraste */
            --error-text: #f8d7da;
            --button-bg: #444; /* Ajustado */
            --button-text: #f8f9fa;
            --shadow-color: rgba(255,255,255,0.05); /* Sombra mais sutil */
        }

        body {
            font-family: sans-serif;
            margin: 0; /* Remover margem padr√£o */
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        #toolbar {
            background-color: var(--item-bg);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 3px var(--shadow-color);
            display: flex;
            justify-content: space-between; /* Alinha temps √† esquerda, bot√£o √† direita */
            align-items: center;
            position: sticky; /* Fixa no topo */
            top: 0;
            z-index: 1010; /* Acima do container */
            font-size: 0.9em; /* Tamanho de fonte menor para a toolbar */
        }
        #toolbar-temps span { /* Estilo para cada item de temperatura */
            margin-right: 15px; /* Espa√ßo entre os itens */
            white-space: nowrap; /* Evita quebra de linha */
        }
         #toolbar button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
         }
         #toolbar button:hover {
            opacity: 0.9;
         }

        .container {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            max-width: 1200px;
            margin: 20px auto; /* Adiciona margem superior */
        }
        h1, h2 {
            color: var(--header-color);
            border-bottom: 2px solid var(--border-light-color);
            padding-bottom: 10px;
        }
        h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em;}
        .status-grid, .ams-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .status-item, .ams-unit, .ams-tray {
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 5px;
         }
        .status-item strong { display: block; margin-bottom: 5px; color: var(--label-color); font-size: 0.9em; }
        .status-item p { margin: 8px 0; }
        .status-value { font-size: 1.1em; font-weight: bold; color: var(--value-color); }
        #error-message {
            color: var(--error-text);
            background-color: var(--error-bg);
            border: 1px solid var(--error-border);
            padding: 10px; border-radius: 4px; font-weight: bold; margin-top: 15px; text-align: center; }
        .progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-bar { height: 24px; background-color: var(--success-color); width: 0%; border-radius: 4px; text-align: center; line-height: 24px; color: white; font-weight: bold; transition: width 0.5s ease-in-out; white-space: nowrap; }
        .ams-unit h3, .ams-tray h4 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid var(--border-light-color); padding-bottom: 5px; }
        .filament-color { display: inline-block; width: 18px; height: 18px; border-radius: 50%; margin-right: 8px; vertical-align: middle; border: 1px solid #555; }
        .ams-tray p { margin: 5px 0; }
        .loading { text-align: center; padding: 20px; color: var(--label-color); }
        .label { font-weight: normal; color: var(--label-color); }
        .value { font-weight: bold; color: var(--value-color); }

        /* Layout de Colunas */
        #layout-container {
            display: flex;
            flex-wrap: wrap; /* Permite quebrar em telas menores se necess√°rio */
            gap: 20px; /* Espa√ßo entre as colunas */
        }
        #left-column {
            flex: 1; /* Coluna esquerda */
            min-width: 200px; /* Reduzido um pouco */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #center-column {
            flex: 3; /* Coluna central mais larga */
            min-width: 350px;
            display: flex; /* Organiza c√¢mera e gr√°fico internamente */
            flex-direction: column;
            gap: 20px;
        }
        #right-column {
            flex: 1; /* Coluna direita */
            min-width: 220px; /* Reduzido um pouco */
            display: flex; /* Organiza Temps/Fans e AMS */
            flex-direction: column;
            gap: 20px;
        }
        /* Ajuste para os grids nas colunas laterais */
        #left-column .status-grid,
        #right-column .status-grid, /* Aplicar tamb√©m ao grid de Temps/Fans */
        #right-column #ams-data {
             grid-template-columns: 1fr; /* For√ßa uma √∫nica coluna */
        }
        /* Estilo para a imagem da c√¢mera */
        #camera-feed {
            width: 100%;
            max-width: 640px; /* Limita um pouco a largura m√°xima */
            height: auto;
            border: 1px solid var(--border-color);
            background-color: var(--item-alt-bg); /* Cor de fundo enquanto carrega */
            transform: rotate(180deg); /* Adiciona rota√ß√£o */
        }
        /* Container do gr√°fico para manter propor√ß√£o */
        #temp-chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            background-color: var(--item-bg); /* Fundo para o gr√°fico */
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
        }
        /* Ajustes Chart.js para tema escuro */
        body.dark-theme .chartjs-legend ul li span {
            color: var(--text-color);
        }
        body.dark-theme .chartjs-tooltip-body span {
            color: var(--text-color); /* Ajuste se necess√°rio */
        }
        body.dark-theme .chartjs-render-monitor { /* Evita flicker branco */
            background-color: var(--item-bg);
        }
        /* Ajustar cores de eixos/grades se necess√°rio */
        /* Chart.defaults.color = 'var(--text-color)'; // Pode ser global ou por op√ß√µes */

    </style>
</head>
<body>
    <div id="toolbar">
        <div id="toolbar-temps">
            <span>üî• <span id="toolbar-nozzle-value">-- / --</span> ¬∞C</span>
            <span>‚èπÔ∏è <span id="toolbar-bed-value">-- / --</span> ¬∞C</span>
            <span id="toolbar-chamber-item" style="display: none;">üå°Ô∏è <span id="toolbar-chamber-value">--</span> ¬∞C</span>
        </div>
        <button id="theme-toggle">üåô Tema Escuro</button>
    </div>

    <div class="container">
        <h1>Monitor Impressora Bambu Lab</h1>
        <div id="error-message" style="display: none;"></div>

        <div id="layout-container">
            <div id="left-column">
                <div> <!-- Bloco Progresso -->
                    <h2>Progresso da Impress√£o</h2>
                    <div id="status-progress" class="status-grid">
                         <div class="loading">Carregando...</div>
                    </div>
                    <div id="progress-bar-section" style="margin-top: 15px;"></div>
                </div>
                <div> <!-- Bloco Temperaturas/Ventoinhas -->
                    <h2>Temperaturas & Ventoinhas</h2>
                    <div id="status-temps-fans" class="status-grid">
                        <div class="loading">Carregando...</div>
                    </div>
                </div>
                 <div> <!-- Bloco Vis√£o Geral (Movido para c√°) -->
                    <h2>Vis√£o Geral</h2>
                    <div id="status-overview" class="status-grid">
                        <div class="loading">Carregando...</div>
                    </div>
                </div>
            </div>

            <div id="center-column">
                <div> <!-- Bloco da C√¢mera -->
                    <h2>C√¢mera</h2>
                    <img id="camera-feed" src="" alt="Camera Feed - Carregando...">
                </div>
                <div> <!-- Bloco do Gr√°fico -->
                    <h2>Hist√≥rico de Temperaturas</h2>
                    <div id="temp-chart-container">
                        <canvas id="tempHistoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="right-column">
                 <!-- Bloco Temperaturas/Ventoinhas Removido daqui -->
                <div> <!-- Bloco AMS -->
                    <h2>AMS</h2>
                    <div id="ams-data" class="ams-grid">
                         <div class="loading">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Obter refer√™ncias aos elementos principais (pode ser feito aqui)
        const overviewDiv = document.getElementById('status-overview');
        const progressDiv = document.getElementById('status-progress');
        const progressBarSection = document.getElementById('progress-bar-section');
        const tempsFansDiv = document.getElementById('status-temps-fans');
        const amsDiv = document.getElementById('ams-data');
        const errorDiv = document.getElementById('error-message');
        const cameraFeed = document.getElementById('camera-feed');
        // Refs para valores na toolbar
        const toolbarNozzleValue = document.getElementById('toolbar-nozzle-value');
        const toolbarBedValue = document.getElementById('toolbar-bed-value');
        const toolbarChamberItem = document.getElementById('toolbar-chamber-item'); // Span que cont√©m o √≠cone+valor da c√¢mara
        const toolbarChamberValue = document.getElementById('toolbar-chamber-value');

        // Declarar vari√°veis do gr√°fico aqui, mas inicializar depois que o DOM carregar
        let chartCtx = null;
        let tempChart = null;
        const MAX_DATA_POINTS = 60;
        const chartData = {
            labels: [], // Timestamps ou contador
            datasets: [
                {
                    label: 'Bico (¬∞C)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    tension: 0.1
                },
                {
                    label: 'Mesa (¬∞C)',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    tension: 0.1
                },
                {
                    label: 'C√¢mara (¬∞C)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    tension: 0.1,
                    hidden: true // Escondido por padr√£o se n√£o houver c√¢mara?
                }
            ]
        };

        // --- Fun√ß√µes (podem ser definidas antes do DOM carregar) ---

        function initializeChart() {
            if (tempChart) {
                tempChart.destroy();
            }
            // Obter contexto S√ì AQUI dentro, quando o DOM est√° pronto
            chartCtx = document.getElementById('tempHistoryChart')?.getContext('2d');
            if (!chartCtx) {
                console.error("N√£o foi poss√≠vel obter o contexto 2D do canvas #tempHistoryChart");
                return;
            }
            tempChart = new Chart(chartCtx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false, // N√£o for√ßar o eixo Y a come√ßar em 0
                            suggestedMin: 20, // Sugere um m√≠nimo razo√°vel
                             title: {
                                display: true,
                                text: 'Temperatura (¬∞C)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tempo'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    animation: {
                        duration: 0 // Desabilita anima√ß√£o para atualiza√ß√µes mais suaves
                    }
                }
            });
        }

        function addDataToChart(timestamp, nozzleTemp, bedTemp, chamberTemp) {
            if (!tempChart) return;

            // Adiciona novo label (timestamp formatado ou apenas um contador)
            const timeLabel = new Date(timestamp).toLocaleTimeString(); // Ou usar um contador simples
            chartData.labels.push(timeLabel);

            // Adiciona novos dados de temperatura
            chartData.datasets[0].data.push(nozzleTemp);
            chartData.datasets[1].data.push(bedTemp);
            chartData.datasets[2].data.push(chamberTemp);

            // Garante que o dataset da c√¢mara s√≥ √© vis√≠vel se houver dados
            if (chamberTemp !== null && chamberTemp !== undefined) {
                 chartData.datasets[2].hidden = false;
            } else {
                // Se n√£o houver dados de c√¢mara nesta atualiza√ß√£o, preenche com null para n√£o ligar pontos
                 chartData.datasets[2].data[chartData.datasets[2].data.length - 1] = null;
                 // Mant√©m a visibilidade como est√° (pode ter sido habilitada antes)
            }

            // Remove pontos de dados antigos se exceder o limite
            while (chartData.labels.length > MAX_DATA_POINTS) {
                chartData.labels.shift();
                chartData.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }

            // Atualiza o gr√°fico
            tempChart.update();
        }

        function createStatusItem(label, value, unit = '') {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'status-item';
            itemDiv.innerHTML = `<strong>${label}</strong><span class="status-value">${value !== undefined && value !== null ? value : 'N/A'}${unit}</span>`;
            return itemDiv;
        }

        function formatTime(minutes) {
            if (minutes === undefined || minutes === null || minutes <= 0) return 'N/A';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            let timeString = '';
            if (h > 0) timeString += `${h}h `;
            timeString += `${m}min`;
            return timeString;
        }

        function hexToRgb(hex) {
            if (!hex || hex.length < 6) return 'rgb(200, 200, 200)'; // Cor padr√£o para inv√°lido/ausente
            const bigint = parseInt(hex.startsWith('#') ? hex.substring(1, 7) : hex.substring(0, 6), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgb(${r}, ${g}, ${b})`;
        }


        function updateStatus() {
            fetch('/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro HTTP ${response.status} ao buscar /status`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!errorDiv) {
                        console.error("Elemento #error-message n√£o encontrado!");
                        return; // Impede a execu√ß√£o se o elemento de erro n√£o existir
                    }
                    errorDiv.style.display = 'none'; // Esconde erro se sucesso

                    // Verifica se os elementos existem antes de tentar limpar
                    if(overviewDiv) overviewDiv.innerHTML = ''; else console.error("#status-overview n√£o encontrado");
                    if(progressDiv) progressDiv.innerHTML = ''; else console.error("#status-progress n√£o encontrado");
                    if(progressBarSection) progressBarSection.innerHTML = ''; else console.error("#progress-bar-section n√£o encontrado");
                    if(tempsFansDiv) tempsFansDiv.innerHTML = ''; else console.error("#status-temps-fans n√£o encontrado");
                    if(amsDiv) amsDiv.innerHTML = ''; else console.error("#ams-data n√£o encontrado");

                    if (Object.keys(data).length === 0 || !data.print) {
                         if(overviewDiv) overviewDiv.innerHTML = '<div class="loading">Aguardando dados da impressora...</div>';
                         if(progressDiv) progressDiv.innerHTML = '<div class="loading">Carregando...</div>';
                         if(tempsFansDiv) tempsFansDiv.innerHTML = '<div class="loading">Carregando...</div>';
                         if(amsDiv) amsDiv.innerHTML = '<div class="loading">Carregando...</div>';

                        // Limpa toolbar temps em caso de erro/sem dados
                        if (toolbarNozzleValue) toolbarNozzleValue.textContent = '-- / --';
                        if (toolbarBedValue) toolbarBedValue.textContent = '-- / --';
                        if (toolbarChamberValue) toolbarChamberValue.textContent = '--';
                        if (toolbarChamberItem) toolbarChamberItem.style.display = 'none';

                        return;
                    }

                    const printData = data.print;

                     // --- Atualizar Toolbar Temps ---
                    if (toolbarNozzleValue) {
                        toolbarNozzleValue.textContent = `${printData.nozzle_temper?.toFixed(1) ?? '-'} / ${printData.nozzle_target_temper?.toFixed(0) ?? '-'}`;
                    }
                    if (toolbarBedValue) {
                        toolbarBedValue.textContent = `${printData.bed_temper?.toFixed(1) ?? '-'} / ${printData.bed_target_temper?.toFixed(0) ?? '-'}`;
                    }
                    if (printData.chamber_temper !== undefined && printData.chamber_temper !== null) {
                        if(toolbarChamberItem) toolbarChamberItem.style.display = 'inline'; // Mostra se houver dados
                        if(toolbarChamberValue) toolbarChamberValue.textContent = `${printData.chamber_temper?.toFixed(1) ?? '-'}`;
                    } else {
                        if(toolbarChamberItem) toolbarChamberItem.style.display = 'none'; // Esconde se n√£o houver dados
                    }

                    // --- Vis√£o Geral ---
                     if(overviewDiv) {
                        overviewDiv.appendChild(createStatusItem('Estado', printData.gcode_state));
                        overviewDiv.appendChild(createStatusItem('Sinal Wi-Fi', printData.wifi_signal));
                    }

                    // --- Progresso da Impress√£o ---
                    const gcodeFile = printData.gcode_file || 'Nenhum';
                    const percent = printData.mc_percent !== undefined ? printData.mc_percent : 0;
                    const remainingMinutes = printData.mc_remaining_time;
                    const layerNum = printData.layer_num || 0;
                    const totalLayerNum = printData.total_layer_num || 0;

                    if(progressDiv) {
                        progressDiv.appendChild(createStatusItem('Arquivo G-code', gcodeFile));
                        progressDiv.appendChild(createStatusItem('Camada', `${layerNum} / ${totalLayerNum}`));
                        progressDiv.appendChild(createStatusItem('Tempo Restante', formatTime(remainingMinutes)));
                    }
                    if(progressBarSection) {
                        const progressBarContainer = document.createElement('div');
                        progressBarContainer.className = 'progress-bar-container';
                        const progressBar = document.createElement('div');
                        progressBar.className = 'progress-bar';
                        progressBar.style.width = `${percent}%`;
                        progressBar.textContent = `${percent}%`;
                        progressBarContainer.appendChild(progressBar);
                        progressBarSection.appendChild(progressBarContainer);
                    }

                    // --- Temperaturas & Ventoinhas (para exibi√ß√£o nos quadros) ---
                    if(tempsFansDiv) {
                        const tempsDiv = document.createElement('div');
                        tempsDiv.className = 'status-item';
                        let tempsHTML = '<strong>Temperaturas (¬∞C)</strong>';
                        tempsHTML += `<p><span class="label">Bico:</span> <span class="value">${printData.nozzle_temper?.toFixed(1) ?? 'N/A'} / ${printData.nozzle_target_temper?.toFixed(1) ?? 'N/A'}</span></p>`;
                        tempsHTML += `<p><span class="label">Mesa:</span> <span class="value">${printData.bed_temper?.toFixed(1) ?? 'N/A'} / ${printData.bed_target_temper?.toFixed(1) ?? 'N/A'}</span></p>`;
                        if (printData.chamber_temper !== undefined) {
                            tempsHTML += `<p><span class="label">C√¢mara:</span> <span class="value">${printData.chamber_temper?.toFixed(1) ?? 'N/A'}</span></p>`;
                        }
                        tempsDiv.innerHTML = tempsHTML;
                        tempsFansDiv.appendChild(tempsDiv);

                        const fansDiv = document.createElement('div');
                        fansDiv.className = 'status-item';
                        let fansHTML = '<strong>Ventoinhas (%)</strong>';
                        fansHTML += `<p><span class="label">Pe√ßa:</span> <span class="value">${printData.cooling_fan_speed ?? 'N/A'}%</span></p>`;
                        fansHTML += `<p><span class="label">Auxiliar:</span> <span class="value">${printData.big_fan1_speed ?? 'N/A'}%</span></p>`;
                        fansHTML += `<p><span class="label">C√¢mara:</span> <span class="value">${printData.big_fan2_speed ?? 'N/A'}%</span></p>`;
                        fansDiv.innerHTML = fansHTML;
                        tempsFansDiv.appendChild(fansDiv);
                    }

                    // --- Adicionar dados ao Gr√°fico ---
                    addDataToChart(Date.now(), printData.nozzle_temper, printData.bed_temper, printData.chamber_temper);

                    // --- Dados do AMS ---
                     if(amsDiv) {
                        if (printData.ams && printData.ams.ams && printData.ams.ams.length > 0) {
                            printData.ams.ams.forEach((amsUnit, amsIndex) => {
                                const unitDiv = document.createElement('div');
                                unitDiv.className = 'ams-unit';
                                unitDiv.innerHTML = `<h3>AMS ${amsIndex + 1} <span class="label">(Temp: ${amsUnit.temp || 'N/A'}¬∞C, Umid: ${amsUnit.humidity || 'N/A'})</span></h3>`;

                                if (amsUnit.tray && amsUnit.tray.length > 0) {
                                    amsUnit.tray.forEach(tray => {
                                        if (!tray.cols && !tray.tray_type) return;

                                        const trayDiv = document.createElement('div');
                                        trayDiv.className = 'ams-tray';
                                        const trayId = tray.id !== undefined ? parseInt(tray.id) : -1;
                                        trayDiv.innerHTML = `<h4>Bandeja ${trayId >= 0 ? trayId + 1 : '?'}</h4>`;

                                        const colorHex = tray.tray_color || 'FFFFFF00';
                                        const colorRgb = hexToRgb(colorHex);

                                        const filamentInfo = document.createElement('p');
                                        const colorSpan = document.createElement('span');
                                        colorSpan.className = 'filament-color';
                                        colorSpan.style.backgroundColor = colorRgb;
                                        filamentInfo.appendChild(colorSpan);

                                        const type = tray.tray_type || 'Desconhecido';
                                        const profile = tray.tray_info_idx ? `(${tray.tray_info_idx})` : '';
                                        const remaining = tray.remain !== undefined ? `${tray.remain}%` : 'N/A';

                                        filamentInfo.appendChild(document.createTextNode(` ${type} ${profile}` ));
                                        trayDiv.appendChild(filamentInfo);

                                        const remainingInfo = document.createElement('p');
                                        remainingInfo.innerHTML = `<span class="label">Restante:</span> <span class="value">${remaining}</span>`;
                                        trayDiv.appendChild(remainingInfo);

                                        unitDiv.appendChild(trayDiv);
                                    });
                                    if (unitDiv.querySelectorAll('.ams-tray').length === 0) {
                                         unitDiv.innerHTML += '<p>Nenhuma bandeja com filamento detectada nesta unidade.</p>';
                                    }
                                } else {
                                    unitDiv.innerHTML += '<p>Nenhuma bandeja detectada nesta unidade.</p>';
                                }
                                amsDiv.appendChild(unitDiv);
                            });
                        } else {
                            amsDiv.innerHTML = '<div class="loading">Nenhuma unidade AMS detectada ou sem dados.</div>';
                        }
                    }

                })
                .catch(error => {
                    console.error('Erro ao buscar status:', error);
                    if (errorDiv) {
                        errorDiv.textContent = `Falha ao conectar ao backend (${error.message}). Verifique se o script app.py est√° rodando e configurado corretamente.`;
                        errorDiv.style.display = 'block';
                    }
                     // Limpa √°reas de dados em caso de erro?
                    // if(overviewDiv) overviewDiv.innerHTML = '';
                    // if(progressDiv) progressDiv.innerHTML = '';
                    // ... etc ...
                });
        }

        // --- C√≥digo que roda ap√≥s o DOM carregar ---

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log("DOM completamente carregado e processado.");

            // Inicializa o feed da c√¢mera AGORA
            if (cameraFeed) {
                cameraFeed.src = '/camera_proxy';
                cameraFeed.onerror = () => {
                    console.error('Erro ao carregar o stream da c√¢mera em /camera_proxy');
                    cameraFeed.alt = 'Erro ao carregar c√¢mera. Verifique URL e se a c√¢mera est√° ativa.';
                };
            } else {
                console.error("Elemento da c√¢mera #camera-feed n√£o encontrado.");
            }

            // Inicializa o gr√°fico AGORA
            initializeChart();

            // Inicia a busca de status e o intervalo AGORA
            updateStatus();
            setInterval(updateStatus, 3000);
        });

        // --- L√≥gica do Tema Claro/Escuro ---
        const themeToggleButton = document.getElementById('theme-toggle');

        // Fun√ß√£o para aplicar o tema (lido do localStorage ou padr√£o)
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggleButton.textContent = '‚òÄÔ∏è Tema Claro';
                // Atualizar op√ß√µes do gr√°fico para o tema escuro
                if (tempChart) {
                    Chart.defaults.color = '#dee2e6'; // Cor padr√£o para textos no gr√°fico
                    tempChart.options.scales.x.ticks.color = '#adb5bd';
                    tempChart.options.scales.y.ticks.color = '#adb5bd';
                    tempChart.options.scales.x.grid.color = 'rgba(255, 255, 255, 0.1)';
                    tempChart.options.scales.y.grid.color = 'rgba(255, 255, 255, 0.1)';
                     tempChart.options.scales.x.title.color = '#e9ecef';
                    tempChart.options.scales.y.title.color = '#e9ecef';
                    tempChart.options.plugins.legend.labels.color = '#e9ecef';
                    tempChart.update();
                }
            } else {
                document.body.classList.remove('dark-theme');
                themeToggleButton.textContent = 'üåô Tema Escuro';
                // Atualizar op√ß√µes do gr√°fico para o tema claro
                 if (tempChart) {
                    Chart.defaults.color = '#666'; // Cor padr√£o para textos no gr√°fico
                    tempChart.options.scales.x.ticks.color = '#666';
                    tempChart.options.scales.y.ticks.color = '#666';
                    tempChart.options.scales.x.grid.color = 'rgba(0, 0, 0, 0.1)';
                    tempChart.options.scales.y.grid.color = 'rgba(0, 0, 0, 0.1)';
                    tempChart.options.scales.x.title.color = '#333';
                    tempChart.options.scales.y.title.color = '#333';
                    tempChart.options.plugins.legend.labels.color = '#333';
                    tempChart.update();
                }
            }
        }

        // Fun√ß√£o para alternar o tema
        function toggleTheme() {
            let currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            let newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme); // Salva a prefer√™ncia
            applyTheme(newTheme);
        }

        // Event listener para o bot√£o
        themeToggleButton.addEventListener('click', toggleTheme);

        // Aplicar o tema salvo ao carregar a p√°gina
        const savedTheme = localStorage.getItem('theme') || 'light'; // Padr√£o √© 'light'
        applyTheme(savedTheme);

    </script>
</body>
</html> 